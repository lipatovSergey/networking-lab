# Лаборатория №3 — Анализ TCP-трафика (packet sniffing)

## Цель лаборатории

Понять, **как реально работает TCP под HTTP**:

- как устанавливается соединение
- как передаются данные
- что означают `seq`, `ack`, `win`
- почему один HTTP-запрос — это несколько TCP-пакетов

---

## Инструменты

- Express (как реальный HTTP-сервер)
- `tcpdump` (анализ TCP-пакетов)
- `curl` (HTTP-клиент)

---

## Общая картина

HTTP работает **поверх TCP**.
TCP — это **двунаправленный поток байтов**, а не сообщения или пакеты.

В каждом TCP-соединении есть **два независимых потока**:

- клиент → сервер
- сервер → клиент

У каждого потока:

- свой `seq`
- свой `ack`
- своё окно `win`

---

## TCP handshake

Перед передачей данных выполняется трёхшаговое соединение:

1. `SYN` — клиент запрашивает соединение
2. `SYN + ACK` — сервер подтверждает
3. `ACK` — клиент подтверждает подтверждение

После этого соединение считается установленным.

---

## Передача данных

### HTTP-запрос

Клиент отправляет HTTP-запрос:

- данные передаются в TCP-пакете с флагом `P.` (PSH + ACK)
- `seq` показывает диапазон отправленных байтов
- `ack` подтверждает данные, полученные **от сервера**

### HTTP-ответ

Сервер отправляет ответ:

- использует **свой собственный `seq`**
- `ack` подтверждает байты, полученные **от клиента**
- `ack` не изменяется, если клиент больше ничего не отправлял

---

## Закрытие соединения

Соединение закрывается через `FIN`:

- одна сторона отправляет `FIN`
- другая подтверждает
- затем закрывается сама

---

## Значение основных полей TCP

### `seq` (sequence number)

Показывает:

> с какого байта **я отправляю данные**

Пример:

```
seq 1:78
```

Означает:

- отправлены байты `1–77`
- всего 77 байт данных

---

### `ack` (acknowledgement number)

Показывает:

> какой байт **я ожидаю получить следующим от другой стороны**

Правило:

```
ack = N  ⇔  получены байты 1..(N−1)
```

Пример:

```
ack 78
```

Означает:

- получены байты `1–77`
- следующий ожидаемый байт — `78`

---

### `win` (receive window)

Показывает:

> сколько байтов **я могу ещё принять**, начиная с `ack`

`win`:

- отражает **состояние приёмного TCP-буфера**
- не связан напрямую с количеством уже полученных данных
- может немного колебаться (`512 → 509` и т.д.)

Пример:

```
ack 412
win 512
```

Означает:

- получены байты `1–411`
- начиная с `412` можно принять ещё 512 байт

---

## Важные выводы

- TCP **не сбрасывает `seq` и `ack` между HTTP-запросами**
- HTTP-запросы — это логика приложения, TCP — транспорт
- `ack` подтверждает **противоположное направление**
- `win` — это **flow control**, а не скорость сети
- `win = 0` означает, что приёмник временно не может принимать данные

---

## Главный инсайт лаборатории

> TCP — это не пакеты и не запросы.
> Это два независимых потока байтов с подтверждениями и управлением буферами.

HTTP — всего лишь протокол, который использует этот механизм.
